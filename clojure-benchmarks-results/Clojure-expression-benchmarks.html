<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-us"><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>Clojure expression benchmarks</title>
  <meta content="Andy Fingerhut" name="author"></head><body>
[<a href="Clojure-benchmarks.html">benchmarks main page</a>] [<a href="Clojure-whole-program-benchmarks.html">whole program benchmarks</a>] [expression benchmarks] [<a href="Clojure-version-history.html">Clojure version history</a>] [<a href="Hardware-and-software-used-for-Clojure-benchmarks.html">hardware and software used</a>]<br>
<h1>Clojure expression benchmarks</h1>

For these benchmarks a slightly modified version of Hugo Duncan's <a href="https://github.com/hugoduncan/criterium">criterium</a>
is used to perform the measurements.&nbsp; See below for details on my
changes.&nbsp; The basic idea of criterium is to first run the
expression many times to cause the JVM's <a href="http://en.wikipedia.org/wiki/Just-in-time_compilation">JIT compiler</a>
to optimize the code for that expression, and only after that to run
the expression as many times as possible in about 30 seconds.&nbsp; The
warmup time is at least 10 seconds in duration.&nbsp; The final measurement
presented here is the average time it took each expression evaluation
to complete, after the warmup time is complete.<br>



<br>



The slightly modified version of criterium is available <a href="https://github.com/jafingerhut/criterium">here</a>.&nbsp; The only changes made were:<br>



<ol>
<li><span style="font-weight: bold;"></span>Include more information about the JVM being run and the
benchmarking options used in the Clojure map that is the return value
of the <span style="font-family: monospace;">benchmark*</span> function.</li><li>Reduce the per-iteration overhead of the inner loop in function <span style="font-family: monospace;">execute-expr</span> that
repeatedly executes the expression to be measured.</li>
</ol>Details for number 2:<br>
<br>
In criterium, the function <span style="font-family: monospace;">execute-expr</span>
implements the inner loop that repeatedly executes the expression being
measured and calculates the total elapsed time.&nbsp; In the version of
criterium I started with, <span style="font-family: monospace;">execute-expr</span> uses boxed arithmetic for the loop variables, and computes a hash
function on the expression's return value in each iteration.<br>
<br>
I modified <span style="font-family: monospace;">execute-expr</span> to use primitive arithmetic for the loop
variables and to store the return value of the expression in a Java
array.&nbsp; The final hash computation is still done, but only after the
measurement loop is complete.<br>
<br>
These changes make no noticeable
difference to the measurements if the expression takes a long time to
complete (e.g. tens of milliseconds), but they make a significant
difference
for expressions that take a few nanoseconds to complete.&nbsp; Even
with
these changes, note that for very fast expressions there is a
significant fraction of the time reported that is for the remaining
overhead: updating primitive integer loop variables and storing the
expression return value in a Java array.<br>




<br>
</body></html>